@page "/"
@using SimplAgent.Shared.Dtos
@using SimplAgent.Shared.Dtos.Contracts
@rendermode InteractiveServer
@inject SimpleAgentClient AgentClient

<PageTitle>Home</PageTitle>

<h1>Hello !</h1>

<p>Welcome to AI - SimplAgent</p>

<div class="chat-container" style="max-width:500px; display:flex; flex-direction:column; gap:10px;">
    <div class="chat-messages" style="border:1px solid #ccc; padding:10px; min-height:200px;">
        @foreach (var msg in Messages)
        {
            <div style="margin-bottom:4px;">
                <strong>@msg.Role:</strong> @msg.Content
            </div>
        }
    </div>

    <div class="chat-input" style="display:flex;">
        <input @bind="UserInput" @bind:event="oninput" @onkeydown="HandleKeyDown" class="form-control" placeholder="Type your message..."
               style="flex:1; border:1px solid #ccc; border-radius:4px; padding:5px;" />
        <button class="btn btn-primary" style="margin-left:5px;" @onclick="SendMessage">Send</button>
    </div>
</div>

@code {
    private string UserInput = string.Empty;
    private List<ChatMessage> Messages = new();

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(UserInput))
            return;

        var userMessage = UserInput.Trim();
        Messages.Add(new ChatMessage { Role = "User", Content = userMessage });
        UserInput = string.Empty;

        var promptRequest = new PromptRequest(userMessage);
        var responseStream = await AgentClient.ChatAsync(promptRequest);

        string fullResponse = string.Empty;

        await foreach (var chunk in responseStream)
        {
            if (!string.IsNullOrEmpty(chunk.Content))
                fullResponse += chunk.Content;
        }

        Messages.Add(new ChatMessage { Role = "Agent", Content = string.IsNullOrWhiteSpace(fullResponse) ? "No response" : fullResponse });
    }

    private class ChatMessage
    {
        public string Role { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
    }
}
