@page "/upload"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms
@using SimplAgent.Shared.Dtos.Contracts
@inject SimpleAgentClient AgentClient

<PageTitle>Upload Documents</PageTitle>

<h1>Upload Documents to Knowledge Memory</h1>

<InputFile OnChange="HandleUpload" multiple="true" accept=".txt" />

@if (UploadItems.Any())
{
    <h3 class="mt-3">Upload Status</h3>
    <ul class="list-group">
        @foreach (var item in UploadItems)
        {
            <li class="list-group-item">
                <strong>@item.Name</strong> -
                @if (item.Status == UploadStatus.Uploading)
                {
                    <span class="text-warning">Uploading (@item.Progress%)...</span>
                }
                else if (item.Status == UploadStatus.Success)
                {
                    <span class="text-success">Uploaded ✔</span>
                }
                else if (item.Status == UploadStatus.Error)
                {
                    <span class="text-danger">Error: @item.Message</span>
                }
            </li>
        }
    </ul>
}

@if (UploadedDocuments.Any())
{
    <h3 class="mt-3">Uploaded Documents</h3>
    <ul class="list-group">
        @foreach (var doc in UploadedDocuments)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>@doc.Name</strong> - Uploaded at @doc.CreatedAt.ToString("g")
                </div>
                <button class="btn btn-sm btn-danger" @onclick="() => RemoveDocument(doc.Id)">
                    Remove
                </button>
            </li>
        }
    </ul>
}

@code {
    private List<UploadItem> UploadItems = new();
    private List<DocumentDto> UploadedDocuments = new();

    protected override async Task OnInitializedAsync()
    {
        // Load existing documents from backend
        UploadedDocuments = (await AgentClient.GetAllDocumentsAsync()).ToList();
    }

    private async Task HandleUpload(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles();

        if (files.Count == 0)
            return;

        UploadItems.Clear();

        foreach (var file in files)
        {
            var uploadItem = new UploadItem
                {
                    Name = file.Name,
                    Status = UploadStatus.Uploading,
                    Progress = 0
                };

            UploadItems.Add(uploadItem);
            StateHasChanged();

            try
            {
                // Simulate progress
                for (int i = 0; i <= 100; i += 20)
                {
                    uploadItem.Progress = i;
                    StateHasChanged();
                    await Task.Delay(200);
                }

                // Upload to API
                var uploadedDocs = await AgentClient.UploadDocumentsAsync(new List<IBrowserFile> { file });

                uploadItem.Status = UploadStatus.Success;
                uploadItem.Message = "Successfully uploaded";

                // Add to list
                if (uploadedDocs != null)
                {
                    UploadedDocuments.AddRange(uploadedDocs);
                }
                StateHasChanged();

            }
            catch (Exception ex)
            {
                uploadItem.Status = UploadStatus.Error;
                uploadItem.Message = $"Error: {ex.Message}";
            }

            StateHasChanged();
        }

        // Clear upload progress list after a short delay
        await Task.Delay(2000);
        UploadItems.Clear();
    }

    private async Task RemoveDocument(Guid id)
    {
        var doc = UploadedDocuments.FirstOrDefault(d => d.Id == id);
        if (doc != null)
        {
            // Call backend API to remove document
            await AgentClient.RemoveDocumentAsync(doc.Id);

            UploadedDocuments.Remove(doc);
        }
    }
}
